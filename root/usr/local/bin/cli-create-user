#!/bin/bash

set -o nounset   ## set -u : exit the script if you try to use an uninitialised variable
set -o errexit   ## set -e : exit the script if any statement returns a non-true return value

# Change the username from 'ubuntu' to 'application'
usermod -l application ubuntu

# Change the group name from 'ubuntu' to 'application' if necessary
groupmod -n application ubuntu

# Change the home directory to /home/application and move its contents
usermod -d /home/application -m application

# Replace 'ubuntu' with 'application' in /etc/passwd
sed -i 's/ubuntu/application/g' /etc/passwd

# Replace 'ubuntu' with 'application' in /etc/group
sed -i 's/ubuntu/application/g' /etc/group

# Replace 'ubuntu' with 'application' in /etc/shadow
sed -i 's/ubuntu/application/g' /etc/shadow

# Use gosu to run commands as root
gosu root bash -c "
    # Ensure the 'application' user can use sudo without a password
    echo 'application ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/application
    chmod 0440 /etc/sudoers.d/application
"

# Switch to the 'application' user
exec gosu application bash